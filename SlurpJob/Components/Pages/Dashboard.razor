@page "/"
@using SlurpJob.Components
@using SlurpJob.Services
@using SlurpJob.Data
@using SlurpJob.Models
@inject SlurpJob.Services.IngestionService Ingestion
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

@* 2D Map Canvas *@
<canvas id="mapViz"></canvas>

<div class="dashboard-overlay">
    <div class="header">
        <div class="brand">SLURPJOB</div>
        <div class="stats">
            <div class="stat-item">
                <span class="label">EVENTS</span>
                <span class="value">@Ingestion.TotalEvents.ToString("N0")</span>
            </div>
            <div class="stat-item">
                <span class="label">THREATS</span>
                <span class="value" style="color: #ff4444">@Ingestion.ThreatsDetected.ToString("N0")</span>
            </div>
             <div class="stat-item">
                <span class="label">CPS</span>
                <span class="value">@((int)Ingestion.EventsPerSecond)</span>
            </div>
        </div>
    </div>

    <div class="left-panel">
         <LiveFeed OnEventSelected="ShowPayload" />
    </div>

    <div class="bottom-panel">
        <div class="timeline-container">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
</div>

<PayloadInspector @ref="_payloadInspector" />

@code {
    private PayloadInspector _payloadInspector = default!;
    private System.Threading.Timer? _refreshTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try {
                // Initialize Globe and Timeline
                // Use catch to ensure one failure doesn't stop the other
                try { await JS.InvokeVoidAsync("slurpMap2D.init", "mapViz"); } catch(Exception ex) { Console.WriteLine("Map2D Init: " + ex.Message); }
                try { await JS.InvokeVoidAsync("initTimeline", "timelineChart", DotNetObjectReference.Create(this)); } catch(Exception ex) { Console.WriteLine("Timeline Init: " + ex.Message); }
            } catch (Exception ex) {
                Console.WriteLine("JS Init Failed: " + ex.Message);
            }
            
            // Start Refresh Timer for stats
            _refreshTimer = new System.Threading.Timer(_ =>InvokeAsync(StateHasChanged), null, 1000, 1000);
        }
    }

    private void ShowPayload(IncidentLog incident)
    {
        if (incident == null) return;
        var payload = incident.Evidence?.PayloadBlob ?? Array.Empty<byte>();
        _payloadInspector.Open(payload);
    }

    [JSInvokable]
    public async Task<object> GetChartData()
    {
        return new { };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
