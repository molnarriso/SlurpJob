@page "/"
@using SlurpJob.Components
@using SlurpJob.Models
@using SlurpJob.Services
@inject IJSRuntime JS
@inject MemoryStore MemoryStore
@implements IDisposable

<PageTitle>SlurpJob Dashboard</PageTitle>

<style>
    html, body {
        overflow: hidden !important;
        height: 100vh;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
    }
</style>

<div class="container-fluid vh-100 d-flex flex-column p-0">
    <div class="row flex-fill m-0" style="min-height: 0; max-height: calc(100vh - 220px);">
        <!-- Live Feed (Left) -->
        <div class="col-md-3 h-100 p-0 border-end border-secondary">
            <LiveFeed OnEventSelected="ShowPayload" />
        </div>

        <!-- Visualization (Center) -->
        <div class="col-md-6 h-100 p-0 position-relative bg-black">
            @if (_isGlobeMode)
            {
                <div id="globeViz" style="width: 100%; height: 100%;"></div>
            }
            else
            {
                <canvas id="map2dCanvas" style="width: 100%; height: 100%;"></canvas>
            }
            
            <!-- Header Overlay -->
            <div class="position-absolute top-0 start-0 p-3 pointer-events-none">
                <h1 class="display-6 text-light" style="text-shadow: 0 0 10px #0ff; font-family: 'Courier New', monospace;">SLURPJOB</h1>
                <div class="text-secondary small">Network Telescope Active</div>
            </div>
            
            <!-- Mode Toggle Buttons -->
            <div class="position-absolute top-0 start-50 translate-middle-x p-3">
                <div class="btn-group" role="group" style="pointer-events: auto;">
                    <button class="btn btn-sm mode-btn @(_isGlobeMode ? "active" : "")" @onclick="() => SetMode(true)">
                        üåç Globe
                    </button>
                    <button class="btn btn-sm mode-btn @(!_isGlobeMode ? "active" : "")" @onclick="() => SetMode(false)">
                        üó∫Ô∏è 2D Map
                    </button>
                </div>
            </div>
        </div>

        <!-- Intelligence (Right) -->
        <div class="col-md-3 h-100 p-2 bg-dark text-light border-start border-secondary overflow-auto">
             <h5 class="border-bottom border-secondary pb-2 mb-3">Intelligence</h5>
             
             <div class="card bg-dark border-info text-info mb-3">
                 <div class="card-body">
                     <h6 class="card-title">Active Dossiers</h6>
                     <p class="card-text display-6">@MemoryStore.GetDossiers().Count()</p>
                 </div>
             </div>

             <div class="card bg-dark border-warning text-warning mb-3">
                 <div class="card-body">
                     <h6 class="card-title">Recent Events</h6>
                     <p class="card-text display-6">@MemoryStore.GetLiveFeed().Count()</p>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Timeline Panel -->
    <div class="row m-0" style="height: 220px;">
        <div class="col-12 p-2">
            <AttackTimeline />
        </div>
    </div>
</div>

<PayloadInspector @ref="_inspector" />

<style>
    .mode-btn {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        color: #6c757d;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        padding: 0.375rem 0.75rem;
    }
    
    .mode-btn:hover {
        background: rgba(13, 110, 253, 0.2);
        border-color: rgba(13, 110, 253, 0.5);
        color: #adb5bd;
    }
    
    .mode-btn.active {
        background: rgba(13, 110, 253, 0.4);
        border-color: #0dcaf0;
        color: #0dcaf0;
        font-weight: 600;
    }
    
    .mode-btn.active:hover {
        background: rgba(13, 110, 253, 0.5);
        color: #fff;
    }
</style>

@code {
    private PayloadInspector _inspector = default!;
    private System.Threading.Timer? _vizTimer;
    private bool _isGlobeMode = true;
    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeVisualization();
            _vizTimer = new System.Threading.Timer(UpdateVisualization, null, 2000, 3000);
            _initialized = true;
        }
    }

    private async Task InitializeVisualization()
    {
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpGlobe.init", "globeViz");
        }
        else
        {
            await JS.InvokeVoidAsync("slurpMap2D.init", "map2dCanvas");
        }
    }

    private async void UpdateVisualization(object? state)
    {
        if (!_initialized) return;
        
        try
        {
            var countryData = MemoryStore.GetCountryAttackCounts();
            
            await InvokeAsync(async () =>
            {
                if (_isGlobeMode)
                {
                    await JS.InvokeVoidAsync("slurpGlobe.updateHeatmap", countryData);
                }
                else
                {
                    await JS.InvokeVoidAsync("slurpMap2D.updateHeatmap", countryData);
                }
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Visualization Error: {ex.Message}");
        }
    }

    private async Task SetMode(bool isGlobeMode)
    {
        if (_isGlobeMode == isGlobeMode) return; // Already in this mode
        
        _isGlobeMode = isGlobeMode;
        
        // Dispose old visualization
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpMap2D.dispose");
        }
        else
        {
            await JS.InvokeVoidAsync("slurpGlobe.dispose");
        }
        
        StateHasChanged();
        
        // Wait for DOM to update
        await Task.Delay(100);
        
        // Initialize new visualization
        await InitializeVisualization();
        
        // Immediate update with current data
        var countryData = MemoryStore.GetCountryAttackCounts();
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpGlobe.updateHeatmap", countryData);
        }
        else
        {
            await JS.InvokeVoidAsync("slurpMap2D.updateHeatmap", countryData);
        }
    }

    private void ShowPayload(LiveEvent evt)
    {
        byte[] payload = evt.PayloadSnippet;
        
        if (!string.IsNullOrEmpty(evt.PayloadHash))
        {
            var dossier = MemoryStore.GetDossiers().FirstOrDefault(d => d.PayloadHash == evt.PayloadHash);
            if (dossier != null)
            {
                payload = dossier.PayloadData;
            }
        }

        _inspector.Open(payload);
    }

    public void Dispose()
    {
        _vizTimer?.Dispose();
    }
}
