@page "/"
@using SlurpJob.Components
@using SlurpJob.Models
@using SlurpJob.Services
@inject IJSRuntime JS
@inject MemoryStore MemoryStore
@implements IDisposable

<PageTitle>SlurpJob Dashboard</PageTitle>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    html, body {
        overflow: hidden !important;
        height: 100vh;
        width: 100vw;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .dashboard-container {
        display: flex;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
    }
    
    .left-panel {
        width: 60%;
        height: 100vh;
        background: #212529;
        border-right: 1px solid #343a40;
    }
    
    .right-panel {
        width: 40%;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    .globe-panel {
        flex: 1;
        background: #000;
        position: relative;
        min-height: 0;
    }
    
    .timeline-panel {
        height: 220px;
        background: #1a1d20;
        border-top: 1px solid #343a40;
        padding: 8px;
    }
    
    .mode-btn {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        color: #6c757d;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        padding: 0.375rem 0.75rem;
    }
    
    .mode-btn:hover {
        background: rgba(13, 110, 253, 0.2);
        border-color: rgba(13, 110, 253, 0.5);
        color: #adb5bd;
    }
    
    .mode-btn.active {
        background: rgba(13, 110, 253, 0.4);
        border-color: #0dcaf0;
        color: #0dcaf0;
        font-weight: 600;
    }
    
    .mode-btn.active:hover {
        background: rgba(13, 110, 253, 0.5);
        color: #fff;
    }
</style>

<div class="dashboard-container">
    <!-- LEFT: Live Feed (60%) -->
    <div class="left-panel">
        <LiveFeed OnEventSelected="ShowPayload" />
    </div>

    <!-- RIGHT: Globe + Timeline (40%) -->
    <div class="right-panel">
        <!-- TOP: Globe/Map Visualization -->
        <div class="globe-panel">
            @if (_isGlobeMode)
            {
                <div id="globeViz" style="width: 100%; height: 100%;"></div>
            }
            else
            {
                <canvas id="map2dCanvas" style="width: 100%; height: 100%;"></canvas>
            }
            
            <!-- Header Overlay -->
            <div class="position-absolute top-0 start-0 p-3 pointer-events-none">
                <h1 class="display-6 text-light" style="text-shadow: 0 0 10px #0ff; font-family: 'Courier New', monospace;">SLURPJOB</h1>
                <div class="text-secondary small">Network Telescope Active</div>
            </div>
            
            <!-- Mode Toggle (Centered) -->
            <div class="position-absolute top-0 start-50 translate-middle-x p-3">
                <div class="btn-group" role="group" style="pointer-events: auto;">
                    <button class="btn btn-sm mode-btn @(_isGlobeMode ? "active" : "")" @onclick="() => SetMode(true)">
                        üåç Globe
                    </button>
                    <button class="btn btn-sm mode-btn @(!_isGlobeMode ? "active" : "")" @onclick="() => SetMode(false)">
                        üó∫Ô∏è 2D Map
                    </button>
                </div>
            </div>
            
            <!-- Stats Overlay (Top Right) -->
            <div class="position-absolute top-0 end-0 p-3 pointer-events-none">
                <div class="text-info small mb-1">
                    <strong>Dossiers:</strong> @MemoryStore.GetDossiers().Count()
                </div>
                <div class="text-warning small">
                    <strong>Events:</strong> @MemoryStore.GetLiveFeed().Count()
                </div>
            </div>
        </div>

        <!-- BOTTOM: Timeline -->
        <div class="timeline-panel">
            <AttackTimeline />
        </div>
    </div>
</div>

<PayloadInspector @ref="_inspector" />

@code {
    private PayloadInspector _inspector = default!;
    private System.Threading.Timer? _vizTimer;
    private bool _isGlobeMode = false; // Default to 2D map
    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeVisualization();
            _vizTimer = new System.Threading.Timer(UpdateVisualization, null, 2000, 3000);
            _initialized = true;
        }
    }

    private async Task InitializeVisualization()
    {
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpGlobe.init", "globeViz");
        }
        else
        {
            await JS.InvokeVoidAsync("slurpMap2D.init", "map2dCanvas");
        }
    }

    private async void UpdateVisualization(object? state)
    {
        if (!_initialized) return;
        
        try
        {
            var countryData = MemoryStore.GetCountryAttackCounts();
            
            await InvokeAsync(async () =>
            {
                if (_isGlobeMode)
                {
                    await JS.InvokeVoidAsync("slurpGlobe.updateHeatmap", countryData);
                }
                else
                {
                    await JS.InvokeVoidAsync("slurpMap2D.updateHeatmap", countryData);
                }
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Visualization Error: {ex.Message}");
        }
    }

    private async Task SetMode(bool isGlobeMode)
    {
        if (_isGlobeMode == isGlobeMode) return;
        
        _isGlobeMode = isGlobeMode;
        
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpMap2D.dispose");
        }
        else
        {
            await JS.InvokeVoidAsync("slurpGlobe.dispose");
        }
        
        StateHasChanged();
        await Task.Delay(100);
        await InitializeVisualization();
        
        var countryData = MemoryStore.GetCountryAttackCounts();
        if (_isGlobeMode)
        {
            await JS.InvokeVoidAsync("slurpGlobe.updateHeatmap", countryData);
        }
        else
        {
            await JS.InvokeVoidAsync("slurpMap2D.updateHeatmap", countryData);
        }
    }

    private void ShowPayload(LiveEvent evt)
    {
        byte[] payload = evt.PayloadSnippet;
        
        if (!string.IsNullOrEmpty(evt.PayloadHash))
        {
            var dossier = MemoryStore.GetDossiers().FirstOrDefault(d => d.PayloadHash == evt.PayloadHash);
            if (dossier != null)
            {
                payload = dossier.PayloadData;
            }
        }

        _inspector.Open(payload);
    }

    public void Dispose()
    {
        _vizTimer?.Dispose();
    }
}
